<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Contrato e Nota Fiscal</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --primary-color: #008000; --primary-color-dark: #006400; --text-light: #ffffff; --text-dark: #1c1e21; --text-muted: #657786; --bg-main: #f0f2f5; --bg-card: #ffffff; --bg-hover: #f0fff0; --bg-active: #d0edd0; --border-color: #e1e8ed; --kpi-bad: #d93025; --kpi-good: #1e8e3e; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: var(--bg-main); margin: 0; padding: 20px; color: var(--text-dark); }
        .container { max-width: 1200px; margin: 0 auto; }
        .card { background-color: var(--bg-card); border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); overflow: hidden; margin-bottom: 20px; }
        .card-header { background-color: var(--primary-color); padding: 16px 24px; border-bottom: 1px solid var(--primary-color-dark); color: var(--text-light); }
        .card-header h1, .card-header h2 { margin: 0; font-size: 1.5em; color: var(--text-light); }
        .card-body { padding: 24px; }
        .header-grid, .totals-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; }
        .data-item { font-size: 1em; }
        .data-item .label { display: block; font-size: 0.85em; color: var(--text-muted); margin-bottom: 4px; }
        .data-item .value { font-weight: 500; word-wrap: break-word; }
        .table-container { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table thead th { background-color: var(--primary-color); color: var(--text-light); padding: 12px; text-align: left; font-size: 0.9em; white-space: nowrap; position: sticky; top: 0; }
        .data-table thead th.sortable { cursor: pointer; user-select: none; }
        .data-table thead th.sortable:hover { background-color: var(--primary-color-dark); }
        .data-table thead th .sort-arrow { display: inline-block; margin-left: 5px; opacity: 0.7; }
        .data-table tbody tr.main-row { cursor: pointer; border-bottom: 1px solid var(--border-color); }
        .data-table tbody tr.main-row:hover { background-color: var(--bg-hover); }
        .data-table tbody td { padding: 12px; font-size: 0.95em; white-space: nowrap; }
        .details-row { display: none; }
        .details-row.show { display: table-row; }
        .details-content { background-color: #fafafa; padding: 16px; display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; }
        .main-row.active { background-color: var(--bg-active); }
        .kpi-bad { color: var(--kpi-bad); font-weight: bold; }
        .kpi-good { color: var(--kpi-good); }
        .status-container { padding: 40px; text-align: center; }
        .status-message { font-size: 1.2em; font-weight: bold; color: var(--kpi-bad); }
        .hidden { display: none; }
        .spinner { margin: 40px auto; width: 50px; height: 40px; text-align: center; font-size: 10px; }
        .spinner > div { background-color: var(--primary-color); height: 100%; width: 6px; display: inline-block; animation: sk-stretchdelay 1.2s infinite ease-in-out; }
        .spinner .rect2 { animation-delay: -1.1s; } .spinner .rect3 { animation-delay: -1.0s; } .spinner .rect4 { animation-delay: -0.9s; } .spinner .rect5 { animation-delay: -0.8s; }
        @keyframes sk-stretchdelay { 0%, 40%, 100% { transform: scaleY(0.4) } 20% { transform: scaleY(1.0) } }
        .retry-button { background-color: var(--primary-color); color: var(--text-light); border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 20px; }
    </style>
</head>
<body>

    <div id="loading-container" class="container"><div class="spinner"><div class="rect1"></div><div class="rect2"></div><div class="rect3"></div><div class="rect4"></div><div class="rect5"></div></div></div>

    <div id="main-content" class="container hidden">
        <div id="header-card" class="card">
            <div class="card-header"><h1 id="header-title"></h1></div>
            <div class="card-body">
                <div class="header-grid">
                    <div class="data-item"><span class="label">Número da Nota</span><span class="value" id="numero-nota"></span></div>
                    <div class="data-item"><span class="label">Pedido de Compra</span><span class="value" id="pedido-compra"></span></div>
                    <div class="data-item"><span class="label">Contrato</span><span class="value" id="codigo-contrato"></span></div>
                    <div class="data-item"><span class="label">Data do Contrato</span><span class="value" id="data-contrato"></span></div>
                    <div class="data-item"><span class="label">Fornecedor</span><span class="value" id="nome-fornecedor"></span></div>
                    <div class="data-item"><span class="label">Corretor</span><span class="value" id="nome-corretor"></span></div>
                    <div class="data-item"><span class="label">Qtd. de Animais</span><span class="value" id="quantidade-animais"></span></div>
                </div>
            </div>
        </div>
        <div id="items-card" class="card">
             <div class="card-header"><h2>Itens da Nota Fiscal</h2></div>
            <div class="card-body" style="padding: 0;">
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="item">Item <span class="sort-arrow"></span></th>
                                <th class="sortable" data-sort="codigoproduto">Cód. Produto <span class="sort-arrow"></span></th>
                                <th class="sortable" data-sort="descricaoproduto">Descrição <span class="sort-arrow"></span></th>
                                <th class="sortable" data-sort="quantidade">Qtd. <span class="sort-arrow"></span></th>
                                <th class="sortable" data-sort="valorunitario">Vl. Unit. <span class="sort-arrow"></span></th>
                                <th class="sortable" data-sort="valortotal">Vl. Total <span class="sort-arrow"></span></th>
                            </tr>
                        </thead>
                        <tbody id="items-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div id="totals-card" class="card">
            <div class="card-header"><h2>Totalizadores</h2></div>
            <div class="card-body">
                <div class="totals-grid">
                    <div class="data-item"><span class="label">Quantidade Total</span><span class="value" id="total-quantidade"></span></div>
                    <div class="data-item"><span class="label">Valor Total da Nota</span><span class="value" id="total-valor"></span></div>
                    <div class="data-item"><span class="label">Peso Total Saída</span><span class="value" id="total-peso-saida"></span></div>
                    <div class="data-item"><span class="label">Peso Total Chegada</span><span class="value" id="total-peso-chegada"></span></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="error-container" class="container hidden"><div class="status-container"><div id="error-message" class="status-message"></div><button id="retry-button" class="retry-button">Tentar Novamente</button></div></div>

    <script>
        let originalItems = [];
        let currentSort = { key: 'item', dir: 'asc' };

        const formatDate = (dateStr) => { if (!dateStr || dateStr.length !== 8) return dateStr; return `${dateStr.substring(6, 8)}/${dateStr.substring(4, 6)}/${dateStr.substring(0, 4)}`; };
        const formatTime = (timeStr) => { if (!timeStr || !timeStr.trim()) return ''; return `${timeStr.substring(0, 2)}:${timeStr.substring(2, 4)}`; };
        const formatCurrency = (value) => { if (isNaN(value) || value === null) return 'N/A'; return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value); };
        const formatNumber = (value) => { if (isNaN(value) || value === null) return 'N/A'; return value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); };
        const getKpiClass = (value) => { if (isNaN(value) || value === null) return ''; return value > 3 ? 'kpi-bad' : 'kpi-good'; };
        
        function populateHeader(header, notaNumero) {
            document.getElementById('header-title').innerText = `Contrato: ${header.codigocontrato}`;
            document.getElementById('numero-nota').innerText = notaNumero;
            document.getElementById('pedido-compra').innerText = header.pedidocompra;
            document.getElementById('codigo-contrato').innerText = header.codigocontrato;
            document.getElementById('data-contrato').innerText = formatDate(header.datacontrato);
            document.getElementById('nome-fornecedor').innerText = header.nomefornecedor;
            document.getElementById('nome-corretor').innerText = `${header.nomecorretor} (Cód: ${header.codigocorretor})`;
            document.getElementById('quantidade-animais').innerText = header.quantidadeanimais;
        }

        function populateTable(items) {
            const tableBody = document.getElementById('items-tbody');
            tableBody.innerHTML = '';
            items.forEach(item => {
                const mainRow = document.createElement('tr'); mainRow.className = 'main-row';
                mainRow.innerHTML = `<td>${item.item}</td><td>${item.codigoproduto}</td><td>${item.descricaoproduto}</td><td>${item.quantidade}</td><td>${formatCurrency(item.valorunitario)}</td><td>${formatCurrency(item.valortotal)}</td>`;
                const detailsRow = document.createElement('tr'); detailsRow.className = 'details-row';
                detailsRow.innerHTML = `<td colspan="6"><div class="details-content">
                    <div class="data-item"><span class="label">Peso Total (Saída)</span><span class="value">${formatNumber(item.peso)} kg</span></div>
                    <div class="data-item"><span class="label">Peso Individual (Saída)</span><span class="value">${formatNumber(item.pesoindividualsaida)} kg</span></div>
                    <div class="data-item"><span class="label">Peso Total (Chegada)</span><span class="value">${formatNumber(item.pesochegada)} kg</span></div>
                    <div class="data-item"><span class="label">Peso Individual (Chegada)</span><span class="value">${formatNumber(item.pesoindividualchegada)} kg</span></div>
                    <div class="data-item"><span class="label">Quebra (kg)</span><span class="value">${formatNumber(item.quebrakg)} kg</span></div>
                    <div class="data-item"><span class="label">Quebra (%)</span><span class="value ${getKpiClass(item.quebrachegada)}">${formatNumber(item.quebrachegada)} %</span></div>
                    <div class="data-item"><span class="label">Distância</span><span class="value">${item.km || 'N/A'} km</span></div>
                    <div class="data-item"><span class="label">Data/Hora Embarque</span><span class="value">${formatDate(item.dataembarque) || 'N/A'} ${formatTime(item.horaembarque) || ''}</span></div>
                    <div class="data-item"><span class="label">Data/Hora Chegada</span><span class="value">${formatDate(item.datachegada) || 'N/A'} ${formatTime(item.horachegada) || ''}</span></div>
                </div></td>`;
                tableBody.appendChild(mainRow); tableBody.appendChild(detailsRow);
            });
        }
        
        function calculateAndDisplayTotals(items) {
            const totals = items.reduce((acc, item) => {
                acc.quantidade += (parseFloat(item.quantidade) || 0);
                acc.valorTotal += (parseFloat(item.valortotal) || 0);
                // CORREÇÃO: Somar os pesos TOTAIS de cada item
                acc.pesoSaida += (parseFloat(item.peso) || 0);
                acc.pesoChegada += (parseFloat(item.pesochegada) || 0);
                return acc;
            }, { quantidade: 0, valorTotal: 0, pesoSaida: 0, pesoChegada: 0 });
            document.getElementById('total-quantidade').innerText = Math.round(totals.quantidade);
            document.getElementById('total-valor').innerText = formatCurrency(totals.valorTotal);
            document.getElementById('total-peso-saida').innerText = `${formatNumber(totals.pesoSaida)} kg`;
            document.getElementById('total-peso-chegada').innerText = `${formatNumber(totals.pesoChegada)} kg`;
        }

        function addEventListeners() {
            const tableBody = document.getElementById('items-tbody');
            tableBody.addEventListener('click', function(event) {
                const clickedRow = event.target.closest('.main-row');
                if (!clickedRow) return;
                const detailsRow = clickedRow.nextElementSibling;
                document.querySelectorAll('.details-row.show').forEach(openRow => {
                    if (openRow !== detailsRow) { openRow.classList.remove('show'); openRow.previousElementSibling.classList.remove('active'); }
                });
                detailsRow.classList.toggle('show'); clickedRow.classList.toggle('active');
            });
            document.querySelectorAll('.data-table thead th.sortable').forEach(th => {
                th.addEventListener('click', () => {
                    const key = th.dataset.sort;
                    const isAsc = currentSort.key === key && currentSort.dir === 'asc';
                    currentSort.dir = isAsc ? 'desc' : 'asc';
                    originalItems.sort((a, b) => {
                        let valA = a[key]; let valB = b[key];
                        if (typeof valA === 'string') { return valA.localeCompare(valB) * (currentSort.dir === 'asc' ? 1 : -1); }
                        return (valA - valB) * (currentSort.dir === 'asc' ? 1 : -1);
                    });
                    document.querySelectorAll('.data-table thead th .sort-arrow').forEach(arrow => arrow.innerText = '');
                    th.querySelector('.sort-arrow').innerText = currentSort.dir === 'asc' ? '▲' : '▼';
                    populateTable(originalItems);
                });
            });
            document.getElementById('retry-button').addEventListener('click', () => location.reload());
        }

        document.addEventListener("DOMContentLoaded", async function() {
            const loadingContainer = document.getElementById('loading-container');
            const mainContent = document.getElementById('main-content');
            const errorContainer = document.getElementById('error-container');
            const errorMessageDiv = document.getElementById('error-message');
            addEventListeners();
            let params = {};
            let notaNumero = "N/A";

            const startParam = window.Telegram?.WebApp?.initDataUnsafe?.start_param;
            if (startParam) {
                try { params = JSON.parse(atob(startParam)); } 
                catch (e) { loadingContainer.classList.add('hidden'); errorMessageDiv.innerText = `❌ Erro: ${e.message}`; errorContainer.classList.remove('hidden'); return; }
            } else {
                const urlParams = new URLSearchParams(window.location.search);
                params = {
                    filial: urlParams.get('filial'), numero: urlParams.get('numero'), serie: urlParams.get('serie'),
                    fornecedor: urlParams.get('fornecedor'), loja: urlParams.get('loja'), apiKey: urlParams.get('apiKey'),
                    apiUrl: urlParams.get('apiUrl')
                };
            }
            notaNumero = params.numero || "N/A";

            try {
                const { filial, numero, serie, fornecedor, loja, apiKey, apiUrl } = params;
                if (!apiUrl || !apiKey || !filial || !numero) throw new Error("Informações de acesso ou da nota estão ausentes.");
                
                const finalApiUrl = `${apiUrl}?filial=${filial}&numero=${numero}&serie=${serie}&fornecedor=${fornecedor}&loja=${loja}`;
                
                const response = await fetch(finalApiUrl, { headers: { 'x-api-key': apiKey } });
                if (!response.ok) throw new Error(`Erro na API: ${response.status} ${response.statusText}`);
                
                const apiData = await response.json();
                
                if (apiData && apiData.cabecalhocontrato && apiData.itensnotafiscal) {
                    originalItems = apiData.itensnotafiscal;
                    populateHeader(apiData.cabecalhocontrato, notaNumero);
                    populateTable(originalItems);
                    calculateAndDisplayTotals(originalItems);
                    loadingContainer.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                } else {
                    console.log("DADOS REAIS RECEBIDOS DA API:", apiData);
                    throw new Error("A resposta da API não contém as chaves 'cabecalhocontrato' ou 'itensnotafiscal'. Verifique a estrutura no console.");
                }
            } catch (error) {
                console.error("Erro no processamento:", error);
                loadingContainer.classList.add('hidden');
                errorMessageDiv.innerText = `❌ Falha no processamento: ${error.message}`;
                errorContainer.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>